{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="max-w-6xl mx-auto mt-8">
  <div class="bg-white rounded-2xl shadow-md p-6">
    {% if needs_migration %}
      <div class="mb-4 p-3 rounded-md bg-yellow-50 border border-yellow-100 text-yellow-800">
        Database schema missing recent Mitra columns. Run <code class="font-mono">python manage.py makemigrations backend</code> and <code class="font-mono">python manage.py migrate</code>, then reload.
      </div>
    {% endif %}
    <h1 class="text-center text-3xl font-bold mb-6 text-neutral-900">Daftar Mitra</h1>

    <div class="flex items-center justify-end mb-4 gap-3">
      <div id="table-loading" class="flex items-center gap-2 text-sm text-neutral-500 hidden">
        <svg class="animate-spin h-4 w-4 text-neutral-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
        </svg>
        <span>Memuat...</span>
      </div>
      <button id="refresh-btn" class="inline-flex items-center gap-2 px-3 py-1.5 text-sm font-medium rounded-md bg-neutral-100 text-neutral-700 hover:bg-neutral-200 transition">
        <span class="text-lg">ðŸ”„</span>
        <span>Refresh</span>
      </button>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-neutral-100">
        <thead class="bg-neutral-50">
              <tr class="text-left text-sm text-neutral-600">
                <th data-sort-key="nama" class="px-4 py-3 cursor-pointer">Nama <span class="sort-indicator text-xs ml-1"></span></th>
                <th data-sort-key="email" class="px-4 py-3 cursor-pointer">Email <span class="sort-indicator text-xs ml-1"></span></th>
                <th class="px-4 py-3">Deskripsi</th>
                <th class="px-4 py-3">Gambar</th>
                <th data-sort-key="status" class="px-4 py-3 cursor-pointer">Status <span class="sort-indicator text-xs ml-1"></span></th>
                <th data-sort-key="tanggal_daftar" class="px-4 py-3 cursor-pointer">Tanggal Daftar <span class="sort-indicator text-xs ml-1"></span></th>
                <th class="px-4 py-3">Aksi</th>
              </tr>
        </thead>
        <tbody id="mitra-tbody" class="bg-white divide-y divide-neutral-100 text-sm text-neutral-700">
          {% for mitra in mitras %}
          <tr class="border-b hover:bg-gray-50 transition">
            <td class="p-3 align-top">{{ mitra.nama }}</td>
            <td class="p-3 align-top">{{ mitra.email }}</td>
            <td class="p-3 max-w-xs truncate align-top">{{ mitra.deskripsi }}</td>
            <td class="p-3 align-top">
              {% if mitra.gambar %}
                <img src="{{ mitra.gambar.url }}" alt="{{ mitra.nama }}" class="w-20 h-20 object-cover rounded-lg border">
              {% else %}
                <span class="text-gray-400 italic">Tidak ada gambar</span>
              {% endif %}
            </td>
            <td class="p-3 align-top">
              {% if mitra.status == 'approved' %}
                <span class="bg-emerald-100 text-emerald-700 px-2 py-1 rounded-full text-sm font-medium">âœ“ Approved</span>
              {% elif mitra.status == 'pending' %}
                <span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full text-sm font-medium">â€¢ Pending</span>
              {% else %}
                <span class="bg-red-100 text-red-700 px-2 py-1 rounded-full text-sm font-medium">âœ— Rejected</span>
              {% endif %}
            </td>
            <td class="p-3 align-top text-sm text-neutral-600">{{ mitra.tanggal_daftar }}</td>
            <td class="p-3 text-center align-top">
              <button data-id="{{ mitra.id }}" data-action="approve" class="acc-btn btn-acc bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-1 rounded">ACC</button>
              <button data-id="{{ mitra.id }}" data-action="reject" class="reject-btn btn-tolak bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded ml-2">Tolak</button>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="7" class="p-6 text-center text-neutral-500">Belum ada mitra.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Reject modal -->
<div id="rejectModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-lg p-6 w-96">
    <h2 class="text-lg font-semibold mb-2">Alasan Penolakan</h2>
    <textarea id="rejectReason" class="w-full border rounded p-2 mb-4" rows="3" placeholder="Tulis alasan penolakan..."></textarea>
    <div class="flex justify-end gap-2">
      <button id="cancelReject" class="bg-gray-300 px-3 py-1 rounded">Batal</button>
      <button id="confirmReject" class="bg-red-500 text-white px-3 py-1 rounded">Kirim</button>
    </div>
  </div>
</div>

<!-- Toast root -->
<div id="toast-root"></div>

<script src="{% static 'js/admin_mitra.js' %}"></script>
<script src="{% static 'js/admin_mitra.js' %}"></script>
{% endblock %}
