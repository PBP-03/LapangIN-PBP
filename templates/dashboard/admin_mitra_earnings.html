{% extends 'base.html' %}
{% load static %}

{% block title %}Total Earnings Mitra - LapangIN{% endblock %}

{% block content %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<div class="min-h-screen bg-neutral-50">
  <!-- Header -->
  <div class="bg-white border-b border-neutral-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="py-6">
        <div class="flex items-center justify-between">
          <div>
            <div class="flex items-center space-x-2 text-sm text-neutral-600 mb-2">
              <a href="/admin/dashboard" class="hover:text-primary-600">Dashboard</a>
              <span>/</span>
              <span class="text-neutral-900">Total Earnings Mitra</span>
            </div>
            <h1 class="text-2xl font-display font-bold text-neutral-900">
              Total Earnings Mitra
            </h1>
            <p class="text-neutral-600">
              Lihat total pendapatan setiap mitra dari transaksi yang telah selesai
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div id="earningsLoading" class="flex justify-center items-center py-20">
    <div class="w-8 h-8 border-4 border-primary-500 border-t-transparent rounded-full animate-spin"></div>
  </div>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 hidden" id="earningsContent">
    
    <!-- Refunds Section -->
    <div class="bg-white rounded-2xl shadow-soft border border-neutral-200 overflow-hidden mb-6">
      <div class="p-6 border-b border-neutral-200 flex justify-between items-center">
        <h2 class="text-lg font-semibold text-neutral-900">Refund Transactions</h2>
        <button onclick="openCreateRefundModal()" class="inline-flex items-center px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded-lg hover:bg-primary-700 transition-colors">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          Create Manual Refund
        </button>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full" id="refunds-table">
          <thead class="bg-neutral-50 border-b border-neutral-200">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider w-12">#</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider w-40">Mitra</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider w-44">Venue</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider w-36">Amount</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider w-32">Type</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Reason</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider w-28">Actions</th>
            </tr>
          </thead>
          <tbody id="refunds-body" class="bg-white divide-y divide-neutral-200">
            <tr><td colspan="7" class="px-6 py-12 text-center text-neutral-500">Loading refunds...</td></tr>
          </tbody>
        </table>
      </div>
      <div id="refundsEmptyState" class="p-12 text-center hidden">
        <div class="w-16 h-16 bg-neutral-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16l3.5-2 3.5 2 3.5-2 3.5 2z"></path>
          </svg>
        </div>
        <h3 class="text-neutral-900 font-medium mb-2">No refunds yet</h3>
        <p class="text-neutral-600 text-sm">Refunded transactions will appear here</p>
      </div>
    </div>
    
    <!-- Earnings Table -->
    <div class="bg-white rounded-2xl shadow-soft border border-neutral-200 overflow-hidden">
      <div class="p-6 border-b border-neutral-200">
        <h2 class="text-lg font-semibold text-neutral-900">Daftar Total Earnings Mitra</h2>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full" id="earnings-table">
          <thead class="bg-neutral-50 border-b border-neutral-200">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">#</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Nama Mitra</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Email</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Total Earnings & Detail</th>
            </tr>
          </thead>
          <tbody id="earnings-body" class="bg-white divide-y divide-neutral-200">
            <tr><td colspan="4" class="px-6 py-12 text-center text-neutral-500">Memuat data...</td></tr>
          </tbody>
        </table>
      </div>
      <div id="earningsEmptyState" class="p-12 text-center hidden">
        <div class="w-16 h-16 bg-neutral-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
          </svg>
        </div>
        <h3 class="text-neutral-900 font-medium mb-2">Belum ada data earnings mitra</h3>
        <p class="text-neutral-600 text-sm">Data earnings mitra akan muncul di sini setelah ada transaksi selesai</p>
      </div>
    </div>
  </div>

  <!-- Error State -->
  <div id="earningsError" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-20 text-center hidden">
    <div class="w-16 h-16 bg-red-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
      <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
    </div>
    <h3 class="text-neutral-900 font-medium mb-2">Gagal memuat data earnings mitra</h3>
    <p class="text-neutral-600 text-sm mb-4">Terjadi kesalahan saat memuat data</p>
    <button onclick="window.location.reload()" class="btn btn-primary">Coba Lagi</button>
  </div>
</div>

<!-- Transaction Details Modal -->
<div id="transactionDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl max-w-6xl w-full max-h-[90vh] flex flex-col">
    <div class="p-6 border-b border-neutral-200 flex-shrink-0">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-display font-bold text-neutral-900" id="transactionModalMitraName">Detail Transaksi</h2>
        <button onclick="closeTransactionDetailsModal()" class="text-neutral-400 hover:text-neutral-600 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>
    <div id="transactionModalContent" class="p-6 overflow-y-auto flex-1">
      <!-- Transaction details will be loaded here -->
    </div>
    <div class="p-6 border-t border-neutral-200 flex-shrink-0">
      <button onclick="closeTransactionDetailsModal()" class="btn btn-primary w-full">
        Tutup
      </button>
    </div>
  </div>
</div>

<!-- Refund Reason Modal -->
<div id="refundReasonModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl max-w-md w-full">
    <div class="p-6 border-b border-neutral-200">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-display font-bold text-neutral-900">Process Refund</h2>
        <button onclick="closeRefundReasonModal()" class="text-neutral-400 hover:text-neutral-600 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>
    <div class="p-6 space-y-4">
      <!-- Refund Type -->
      <div>
        <label class="block text-sm font-medium text-neutral-700 mb-2">
          Refund Type <span class="text-red-600">*</span>
        </label>
        <select id="inlineRefundType" onchange="updateInlineRefundTypeWarning()" class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
          <option value="mitra_fault">Mitra Fault (Deduct from Mitra)</option>
          <option value="customer_fault">Customer Fault (Deduct from Mitra)</option>
          <option value="platform_fault">Platform Fault (Platform Bears Cost)</option>
          <option value="force_majeure">Force Majeure (Platform Bears Cost)</option>
        </select>
        <div id="inlineRefundTypeWarning" class="mt-2 p-3 bg-red-50 border border-red-200 rounded-lg">
          <p class="text-xs text-red-700">
            <strong>⚠️ Mitra Fault:</strong> The refund amount will be deducted from this mitra's earnings.
          </p>
        </div>
      </div>

      <!-- Refund Reason -->
      <div>
        <label class="block text-sm font-medium text-neutral-700 mb-2">
          Refund Reason <span class="text-red-600">*</span>
        </label>
        <textarea 
          id="refundReasonInput" 
          rows="4" 
          class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 resize-none"
          placeholder="Enter the reason for this refund..."
        ></textarea>
        <p class="mt-2 text-sm text-neutral-500">Please provide a clear reason for processing this refund.</p>
      </div>
    </div>
    <div class="p-6 border-t border-neutral-200 flex gap-3">
      <button onclick="closeRefundReasonModal()" class="flex-1 px-4 py-2 border border-neutral-300 text-neutral-700 rounded-lg hover:bg-neutral-50 transition-colors">
        Cancel
      </button>
      <button onclick="submitRefund()" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
        Process Refund
      </button>
    </div>
  </div>
</div>

<!-- Cancel Refund Confirmation Modal -->
<div id="cancelRefundModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl max-w-md w-full">
    <div class="p-6 border-b border-neutral-200">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-display font-bold text-neutral-900">Cancel Refund</h2>
        <button onclick="closeCancelRefundModal()" class="text-neutral-400 hover:text-neutral-600 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>
    <div class="p-6">
      <div class="flex items-start gap-4">
        <div class="flex-shrink-0 w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
          <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
          </svg>
        </div>
        <div class="flex-1">
          <h3 class="text-lg font-semibold text-neutral-900 mb-2">Are you sure?</h3>
          <p class="text-sm text-neutral-600">
            This will cancel the refund and revert the transaction back to paid status. This action can be undone by processing a new refund if needed.
          </p>
        </div>
      </div>
    </div>
    <div class="p-6 border-t border-neutral-200 flex gap-3">
      <button onclick="closeCancelRefundModal()" class="flex-1 px-4 py-2 border border-neutral-300 text-neutral-700 rounded-lg hover:bg-neutral-50 transition-colors">
        No, Keep Refund
      </button>
      <button onclick="confirmCancelRefund()" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
        Yes, Cancel Refund
      </button>
    </div>
  </div>
</div>

<!-- Create Refund Modal -->
<div id="createRefundModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden flex flex-col">
    <div class="p-6 border-b border-neutral-200 flex-shrink-0">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-display font-bold text-neutral-900">Create Manual Refund</h2>
        <button onclick="closeCreateRefundModal()" class="text-neutral-400 hover:text-neutral-600 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>
    <div class="p-6 overflow-y-auto flex-1">
      <div class="space-y-4">
        <!-- Select Mitra -->
        <div>
          <label class="block text-sm font-medium text-neutral-700 mb-2">Select Mitra <span class="text-red-600">*</span></label>
          <select id="createRefundMitra" onchange="loadMitraTransactionsForRefund()" class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
            <option value="">-- Select Mitra --</option>
          </select>
        </div>

        <!-- Select Transaction -->
        <div id="transactionSelectContainer" class="hidden">
          <label class="block text-sm font-medium text-neutral-700 mb-2">Select Transaction to Refund <span class="text-red-600">*</span></label>
          <div id="transactionsList" class="space-y-2 max-h-80 overflow-y-auto border border-neutral-200 rounded-lg p-4">
            <p class="text-neutral-500 text-sm">Loading transactions...</p>
          </div>
        </div>

        <!-- Refund Type -->
        <div id="refundTypeContainer" class="hidden">
          <label class="block text-sm font-medium text-neutral-700 mb-2">Refund Type <span class="text-red-600">*</span></label>
          <select id="createRefundType" onchange="updateRefundTypeWarning()" class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
            <option value="mitra_fault">Mitra Fault (Deduct from Mitra)</option>
            <option value="customer_fault">Customer Fault (Deduct from Mitra)</option>
            <option value="platform_fault">Platform Fault (Platform Bears Cost)</option>
            <option value="force_majeure">Force Majeure (Platform Bears Cost)</option>
          </select>
          <div id="refundTypeWarning" class="mt-2 p-3 bg-red-50 border border-red-200 rounded-lg">
            <p class="text-xs text-red-700">
              <strong>⚠️ Mitra Fault:</strong> The refund amount will be deducted from this mitra's earnings. Use when the venue/mitra caused the issue (e.g., court not available, facility problems).
            </p>
          </div>
        </div>

        <!-- Refund Reason -->
        <div id="refundReasonContainer" class="hidden">
          <label class="block text-sm font-medium text-neutral-700 mb-2">Refund Reason <span class="text-red-600">*</span></label>
          <textarea id="createRefundReason" rows="4" class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 resize-none" placeholder="Enter detailed reason for this refund (e.g., customer complaint, venue issue, admin error)..."></textarea>
          <p class="mt-1 text-xs text-neutral-500">This reason will be stored in the system for audit purposes</p>
        </div>
      </div>
    </div>
    <div class="p-6 border-t border-neutral-200 flex gap-3 flex-shrink-0">
      <button onclick="closeCreateRefundModal()" class="flex-1 px-4 py-2 border border-neutral-300 text-neutral-700 rounded-lg hover:bg-neutral-50 transition-colors">
        Cancel
      </button>
      <button id="submitRefundBtn" onclick="submitCreateRefund()" class="flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
        Create Refund
      </button>
    </div>
  </div>
</div>
{% endblock %}

{% block script %}
<script>
const apiEarningsUrl = '/api/mitra/earnings/';
const apiRefundsUrl = '/api/refunds/';

async function fetchEarnings() {
  try {
    const res = await fetch(apiEarningsUrl, { credentials: 'same-origin' });
    const json = await res.json();
    console.log('API Response:', json);
    if (json.status !== 'ok') throw new Error(json.message || 'Failed to load earnings');
    renderEarnings(json.data || []);
    document.getElementById('earningsLoading').classList.add('hidden');
    document.getElementById('earningsContent').classList.remove('hidden');
  } catch (err) {
    console.error('Error fetching earnings:', err);
    document.getElementById('earningsLoading').classList.add('hidden');
    document.getElementById('earningsError').classList.remove('hidden');
  }
}

async function fetchRefunds() {
  try {
    const res = await fetch(apiRefundsUrl, { credentials: 'same-origin' });
    const json = await res.json();
    if (json.status !== 'ok') throw new Error(json.message || 'Failed to load refunds');
    renderRefunds(json.data || []);
  } catch (err) {
    console.error('Error fetching refunds:', err);
    document.getElementById('refunds-body').innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-red-600">Failed to load refunds</td></tr>';
  }
}

function renderRefunds(data) {
  const body = document.getElementById('refunds-body');
  const emptyState = document.getElementById('refundsEmptyState');
  const table = document.querySelector('#refunds-table').closest('.overflow-x-auto');
  
  if (data.length === 0) {
    table.classList.add('hidden');
    emptyState.classList.remove('hidden');
    return;
  }
  
  table.classList.remove('hidden');
  emptyState.classList.add('hidden');
  body.innerHTML = '';
  
  data.forEach((r, idx) => {
    // Parse refund type from notes field (format: [REFUND:type] reason | metadata)
    let refundType = 'mitra_fault'; // default
    let cleanReason = r.reason || 'No reason provided';
    
    // Extract refund type (case insensitive)
    const refundTypeMatch = cleanReason.match(/^\[REFUND:(\w+)\]\s*/i);
    if (refundTypeMatch) {
      refundType = refundTypeMatch[1].toLowerCase();
      // Remove the [REFUND:type] prefix
      cleanReason = cleanReason.replace(/^\[REFUND:\w+\]\s*/i, '');
    }
    
    // Also handle plain "REFUND:" without brackets (for backward compatibility)
    if (cleanReason.toLowerCase().startsWith('refund:')) {
      cleanReason = cleanReason.replace(/^refund:\s*/i, '');
    }
    
    // Remove metadata (everything after the first |)
    const pipeIndex = cleanReason.indexOf('|');
    if (pipeIndex !== -1) {
      cleanReason = cleanReason.substring(0, pipeIndex).trim();
    }
    
    // Define type display with colors
    const typeDisplay = {
      'mitra_fault': { label: 'Mitra Fault', color: 'red', icon: '⚠️' },
      'customer_fault': { label: 'Customer Fault', color: 'blue', icon: 'ℹ️' },
      'platform_fault': { label: 'Platform Fault', color: 'yellow', icon: '⚠️' },
      'force_majeure': { label: 'Force Majeure', color: 'purple', icon: '🌧️' }
    };
    
    const typeInfo = typeDisplay[refundType] || typeDisplay['mitra_fault'];
    const typeColorClasses = {
      'red': 'bg-red-100 text-red-800 border-red-200',
      'blue': 'bg-blue-100 text-blue-800 border-blue-200',
      'yellow': 'bg-yellow-100 text-yellow-800 border-yellow-200',
      'purple': 'bg-purple-100 text-purple-800 border-purple-200'
    };
    
    const row = document.createElement('tr');
    row.className = 'hover:bg-neutral-50 transition-colors';
    row.innerHTML = `
      <td class="px-4 py-4 text-sm text-neutral-900">${idx + 1}</td>
      <td class="px-4 py-4">
        <div class="text-sm font-medium text-neutral-900">${escapeHtml(r.mitra_name)}</div>
        <div class="text-xs text-neutral-500">${escapeHtml(r.customer_name)}</div>
      </td>
      <td class="px-4 py-4">
        <div class="text-sm text-neutral-900">${escapeHtml(r.venue_name)}</div>
        <div class="text-xs text-neutral-500">${escapeHtml(r.court_name)}</div>
      </td>
      <td class="px-4 py-4 whitespace-nowrap">
        <div class="text-sm font-bold text-red-600">Rp ${parseInt(r.amount).toLocaleString('id-ID')}</div>
      </td>
      <td class="px-4 py-4">
        <span class="inline-flex items-center px-2.5 py-1 text-xs font-medium rounded-full border ${typeColorClasses[typeInfo.color]}">
          <span class="mr-1">${typeInfo.icon}</span>
          ${typeInfo.label}
        </span>
      </td>
      <td class="px-4 py-4">
        <div class="text-sm text-neutral-600">${escapeHtml(cleanReason)}</div>
      </td>
      <td class="px-4 py-4">
        <button onclick="cancelRefund('${r.id}', '${refundType}')" 
                class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-red-600 hover:text-red-700 bg-red-50 hover:bg-red-100 rounded-lg transition-colors">
          <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
          </svg>
          Cancel Refund
        </button>
      </td>
    `;
    body.appendChild(row);
  });
}

async function cancelRefund(pendapatanId, refundType = 'mitra_fault') {
  currentCancelRefundId = pendapatanId;
  confirmCancelRefund();
}

function closeCancelRefundModal() {
  currentCancelRefundId = null;
  document.getElementById('cancelRefundModal').classList.add('hidden');
}

async function confirmCancelRefund() {
  if (!currentCancelRefundId) return;
  
  try {
    const res = await fetch(`/api/refunds/${currentCancelRefundId}/cancel/`, {
      method: 'DELETE',
      credentials: 'same-origin'
    });
    const json = await res.json();
    
    if (json.status !== 'ok') throw new Error(json.message || 'Failed to cancel refund');
    
    toasterUtils.success('Refund cancelled successfully!', 3000);
    currentCancelRefundId = null;
    fetchRefunds();
    fetchEarnings(); // Refresh earnings too
  } catch (err) {
    toasterUtils.error('Error: ' + err.message, 4000);
    currentCancelRefundId = null;
  }
}

function renderEarnings(data) {
  const body = document.getElementById('earnings-body');
  const emptyState = document.getElementById('earningsEmptyState');
  const table = document.querySelector('.overflow-x-auto');
  if (data.length === 0) {
    table.classList.add('hidden');
    emptyState.classList.remove('hidden');
    return;
  }
  table.classList.remove('hidden');
  emptyState.classList.add('hidden');
  body.innerHTML = '';
  data.forEach((m, idx) => {
    const row = document.createElement('tr');
    row.className = 'hover:bg-neutral-50 transition-colors';
    row.innerHTML = `
      <td class="px-6 py-4 text-sm text-neutral-900">${idx + 1}</td>
      <td class="px-6 py-4">
        <div class="text-sm font-medium text-neutral-900">${escapeHtml(m.mitra_name)}</div>
        <div class="text-xs text-neutral-500">${m.completed_transactions} transaksi selesai</div>
      </td>
      <td class="px-6 py-4">
        <div class="text-sm text-neutral-600">${escapeHtml(m.mitra_email || '')}</div>
      </td>
      <td class="px-6 py-4">
        <div class="font-bold text-primary-700">Rp ${parseInt(m.total_earnings).toLocaleString('id-ID')}</div>
        <button onclick="openTransactionDetailsModal('${m.mitra_id}')" 
                class="mt-2 inline-flex items-center px-3 py-1.5 text-xs font-medium text-primary-600 hover:text-primary-700 bg-primary-50 hover:bg-primary-100 rounded-lg transition-colors">
          <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
          </svg>
          Lihat Detail
        </button>
      </td>
    `;
    body.appendChild(row);
  });
}

function escapeHtml(unsafe) {
  return String(unsafe)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/\"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

async function openTransactionDetailsModal(mitraId) {
  const modal = document.getElementById('transactionDetailsModal');
  const content = document.getElementById('transactionModalContent');
  const mitraName = document.getElementById('transactionModalMitraName');
  
  // Show modal with loading state
  content.innerHTML = '<div class="text-center py-8"><div class="w-8 h-8 border-4 border-primary-500 border-t-transparent rounded-full animate-spin mx-auto"></div><p class="text-neutral-500 mt-4">Memuat data transaksi...</p></div>';
  modal.classList.remove('hidden');
  
  try {
    const res = await fetch(`/api/mitra/${mitraId}/earnings/`, { credentials: 'same-origin' });
    const json = await res.json();
    
    if (json.status !== 'ok') throw new Error(json.message || 'Failed to load transaction details');
    
    const { mitra, summary, transactions } = json.data;
    
    // Update modal title
    mitraName.textContent = `Detail Transaksi - ${escapeHtml(mitra.name)}`;
    
    // Build content
    let html = `
      <div class="mb-6 bg-gradient-to-r from-primary-50 to-blue-50 rounded-2xl p-6 border border-primary-100">
        <h3 class="text-sm font-medium text-neutral-900 mb-4 flex items-center">
          <svg class="w-5 h-5 mr-2 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
          </svg>
          Informasi Mitra
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="flex items-center">
            <svg class="w-4 h-4 mr-2 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
            </svg>
            <span class="text-sm text-neutral-600">${escapeHtml(mitra.email)}</span>
          </div>
          <div class="flex items-center">
            <svg class="w-4 h-4 mr-2 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
            </svg>
            <span class="text-sm text-neutral-600">${escapeHtml(mitra.phone_number)}</span>
          </div>
          <div class="flex items-center">
            <svg class="w-4 h-4 mr-2 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span class="text-sm ${mitra.is_verified ? 'text-green-600' : 'text-yellow-600'}">${mitra.is_verified ? 'Verified' : 'Pending'}</span>
          </div>
        </div>
      </div>
      
      <!-- Summary Cards -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-4 border border-green-200">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-green-700 font-medium">Total Earnings</p>
              <p class="text-2xl font-bold text-green-900 mt-1">Rp ${parseFloat(summary.total_earnings).toLocaleString('id-ID')}</p>
            </div>
            <div class="w-12 h-12 bg-green-200 rounded-full flex items-center justify-center">
              <svg class="w-6 h-6 text-green-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
          </div>
        </div>
        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4 border border-blue-200">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-blue-700 font-medium">Total Komisi</p>
              <p class="text-2xl font-bold text-blue-900 mt-1">Rp ${parseFloat(summary.total_commission).toLocaleString('id-ID')}</p>
            </div>
            <div class="w-12 h-12 bg-blue-200 rounded-full flex items-center justify-center">
              <svg class="w-6 h-6 text-blue-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
              </svg>
            </div>
          </div>
        </div>
        <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-4 border border-purple-200">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-purple-700 font-medium">Total Transaksi</p>
              <p class="text-2xl font-bold text-purple-900 mt-1">${summary.total_transactions}</p>
            </div>
            <div class="w-12 h-12 bg-purple-200 rounded-full flex items-center justify-center">
              <svg class="w-6 h-6 text-purple-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
              </svg>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Charts Section -->
      <div class="grid grid-cols-1 gap-6 mb-6">
        <!-- Earnings Timeline Chart -->
        <div class="bg-white rounded-xl p-6 border border-neutral-200">
          <h3 class="text-lg font-semibold text-neutral-900 mb-4">Earnings Timeline</h3>
          <canvas id="earningsTimelineChart" style="max-height: 300px;"></canvas>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Revenue by Venue Chart -->
          <div class="bg-white rounded-xl p-6 border border-neutral-200">
            <h3 class="text-lg font-semibold text-neutral-900 mb-4">Revenue by Venue</h3>
            <canvas id="revenueByVenueChart" style="max-height: 300px;"></canvas>
          </div>
          
          <!-- Earnings Breakdown Chart -->
          <div class="bg-white rounded-xl p-6 border border-neutral-200">
            <h3 class="text-lg font-semibold text-neutral-900 mb-4">Earnings Breakdown</h3>
            <canvas id="earningsBreakdownChart" style="max-height: 300px;"></canvas>
          </div>
        </div>
      </div>
      
      <!-- Transactions List -->
      <div class="mb-4">
        <h3 class="text-lg font-semibold text-neutral-900 mb-3">Daftar Transaksi</h3>
      </div>
    `;
    
    if (!transactions || transactions.length === 0) {
      html += `
        <div class="text-center py-8 bg-neutral-50 rounded-xl">
          <p class="text-neutral-500">Belum ada transaksi yang selesai</p>
        </div>
      `;
    } else {
      html += '<div class="space-y-3">';
      transactions.forEach((txn, idx) => {
        const txnDate = new Date(txn.booking_date);
        const paidDate = txn.paid_at ? new Date(txn.paid_at) : null;
        
        html += `
          <div class="bg-white border border-neutral-200 rounded-xl p-4 hover:shadow-md transition-shadow">
            <div class="flex items-start justify-between mb-3">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  <h4 class="font-semibold text-neutral-900">${escapeHtml(txn.venue_name)}</h4>
                  <span class="inline-flex px-2 py-0.5 text-xs font-medium bg-blue-100 text-blue-800 rounded">
                    ${escapeHtml(txn.court_name)}
                  </span>
                </div>
                <div class="text-sm text-neutral-600 space-y-1">
                  <div class="flex items-center">
                    <svg class="w-4 h-4 mr-1.5 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    Pelanggan: ${escapeHtml(txn.customer_name)}
                  </div>
                  <div class="flex items-center">
                    <svg class="w-4 h-4 mr-1.5 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    ${txnDate.toLocaleDateString('id-ID')} | ${escapeHtml(txn.time_slot)}
                  </div>
                  ${paidDate ? `
                  <div class="flex items-center">
                    <svg class="w-4 h-4 mr-1.5 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Dibayar: ${paidDate.toLocaleDateString('id-ID')} ${paidDate.toLocaleTimeString('id-ID')}
                  </div>
                  ` : ''}
                </div>
              </div>
              <div class="text-right ml-4">
                <p class="text-xs text-neutral-500 mb-1">Total</p>
                <p class="text-lg font-bold text-neutral-900">Rp ${parseFloat(txn.amount).toLocaleString('id-ID')}</p>
                <p class="text-xs text-red-600 mt-1">- Komisi (${txn.commission_rate}%): Rp ${parseFloat(txn.commission_amount).toLocaleString('id-ID')}</p>
                <p class="text-sm font-bold text-primary-600 mt-1">Net: Rp ${parseFloat(txn.net_amount).toLocaleString('id-ID')}</p>
              </div>
            </div>
          </div>
        `;
      });
      html += '</div>';
    }
    
    content.innerHTML = html;
    
    // Render charts after content is loaded
    if (transactions && transactions.length > 0) {
      renderCharts(transactions, summary);
    }
  } catch (err) {
    console.error(err);
    content.innerHTML = `
      <div class="text-center py-8">
        <div class="w-16 h-16 bg-red-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
        <h3 class="text-neutral-900 font-medium mb-2">Gagal memuat detail transaksi</h3>
        <p class="text-neutral-600 text-sm">${err.message}</p>
      </div>
    `;
  }
}

// Chart rendering
let revenueChart = null;
let breakdownChart = null;
let timelineChart = null;

function renderCharts(transactions, summary) {
  // Destroy existing charts
  if (revenueChart) revenueChart.destroy();
  if (breakdownChart) breakdownChart.destroy();
  if (timelineChart) timelineChart.destroy();
  
  // Group transactions by date
  const dateData = {};
  transactions.forEach(txn => {
    const date = new Date(txn.booking_date).toLocaleDateString('id-ID');
    if (!dateData[date]) {
      dateData[date] = 0;
    }
    dateData[date] += parseFloat(txn.net_amount);
  });
  
  // Sort dates
  const sortedDates = Object.keys(dateData).sort((a, b) => {
    return new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-'));
  });
  const dateRevenues = sortedDates.map(date => dateData[date]);
  
  // Group transactions by venue
  const venueData = {};
  transactions.forEach(txn => {
    if (!venueData[txn.venue_name]) {
      venueData[txn.venue_name] = 0;
    }
    venueData[txn.venue_name] += parseFloat(txn.net_amount);
  });
  
  const venueNames = Object.keys(venueData);
  const venueRevenues = Object.values(venueData);
  
  // Chart 1: Earnings Timeline (Line Chart)
  const ctxTimeline = document.getElementById('earningsTimelineChart');
  if (ctxTimeline) {
    timelineChart = new Chart(ctxTimeline, {
      type: 'line',
      data: {
        labels: sortedDates,
        datasets: [{
          label: 'Daily Earnings (Rp)',
          data: dateRevenues,
          borderColor: 'rgba(59, 130, 246, 1)',
          backgroundColor: 'rgba(59, 130, 246, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4,
          pointBackgroundColor: 'rgba(59, 130, 246, 1)',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          pointRadius: 5,
          pointHoverRadius: 7,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) {
                return 'Rp ' + context.parsed.y.toLocaleString('id-ID');
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return 'Rp ' + (value / 1000).toFixed(0) + 'k';
              }
            }
          },
          x: {
            ticks: {
              maxRotation: 45,
              minRotation: 45
            }
          }
        }
      }
    });
  }
  
  // Chart 2: Revenue by Venue (Bar Chart)
  const ctx1 = document.getElementById('revenueByVenueChart');
  if (ctx1) {
    revenueChart = new Chart(ctx1, {
      type: 'bar',
      data: {
        labels: venueNames,
        datasets: [{
          label: 'Revenue (Rp)',
          data: venueRevenues,
          backgroundColor: 'rgba(59, 130, 246, 0.8)',
          borderColor: 'rgba(59, 130, 246, 1)',
          borderWidth: 1,
          borderRadius: 8,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) {
                return 'Rp ' + context.parsed.y.toLocaleString('id-ID');
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return 'Rp ' + (value / 1000).toFixed(0) + 'k';
              }
            }
          }
        }
      }
    });
  }
  
  // Chart 3: Earnings Breakdown (Doughnut Chart)
  const ctx2 = document.getElementById('earningsBreakdownChart');
  if (ctx2) {
    breakdownChart = new Chart(ctx2, {
      type: 'doughnut',
      data: {
        labels: ['Net Earnings', 'Commission'],
        datasets: [{
          data: [
            parseFloat(summary.total_earnings),
            parseFloat(summary.total_commission)
          ],
          backgroundColor: [
            'rgba(34, 197, 94, 0.8)',
            'rgba(239, 68, 68, 0.8)'
          ],
          borderColor: [
            'rgba(34, 197, 94, 1)',
            'rgba(239, 68, 68, 1)'
          ],
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed || 0;
                return label + ': Rp ' + value.toLocaleString('id-ID');
              }
            }
          }
        }
      }
    });
  }
}

function closeTransactionDetailsModal() {
  document.getElementById('transactionDetailsModal').classList.add('hidden');
  // Destroy charts when closing
  if (timelineChart) {
    timelineChart.destroy();
    timelineChart = null;
  }
  if (revenueChart) {
    revenueChart.destroy();
    revenueChart = null;
  }
  if (breakdownChart) {
    breakdownChart.destroy();
    breakdownChart = null;
  }
}

// Refund modal functions
let currentRefundPendapatanId = null;
let currentCancelRefundId = null;

function showRefundForm(pendapatanId) {
  currentRefundPendapatanId = pendapatanId;
  document.getElementById('refundReasonInput').value = '';
  document.getElementById('inlineRefundType').value = 'mitra_fault';
  updateInlineRefundTypeWarning();
  document.getElementById('refundReasonModal').classList.remove('hidden');
}

function updateInlineRefundTypeWarning() {
  const refundType = document.getElementById('inlineRefundType').value;
  const warningDiv = document.getElementById('inlineRefundTypeWarning');
  
  const warnings = {
    'mitra_fault': {
      color: 'red',
      text: '<strong>⚠️ Mitra Fault:</strong> The refund amount will be deducted from this mitra\'s earnings. Use when the venue/mitra caused the issue (e.g., court not available, facility problems).'
    },
    'customer_fault': {
      color: 'blue',
      text: '<strong>ℹ️ Customer Fault:</strong> The refund amount will still be deducted from mitra\'s earnings (customer already paid). Use for customer-initiated cancellations or no-shows where mitra wasn\'t at fault.'
    },
    'platform_fault': {
      color: 'yellow',
      text: '<strong>⚠️ Platform Fault:</strong> The platform will bear the refund cost - mitra earnings will NOT be affected. Use when LapangIN system errors or admin mistakes caused the issue.'
    },
    'force_majeure': {
      color: 'purple',
      text: '<strong>🌧️ Force Majeure:</strong> The platform will bear the refund cost due to extraordinary circumstances. Use for natural disasters, government restrictions, or unforeseeable events.'
    }
  };
  
  const warning = warnings[refundType];
  warningDiv.className = `mt-2 p-3 border rounded-lg bg-${warning.color}-50 border-${warning.color}-200`;
  warningDiv.innerHTML = `<p class="text-xs text-${warning.color}-700">${warning.text}</p>`;
}

function closeRefundReasonModal() {
  currentRefundPendapatanId = null;
  document.getElementById('refundReasonModal').classList.add('hidden');
}

function submitRefund() {
  const reason = document.getElementById('refundReasonInput').value.trim();
  const refundType = document.getElementById('inlineRefundType').value;
  
  if (!reason) {
    toasterUtils.warning('Refund reason is required', 3000);
    return;
  }

  closeRefundReasonModal();
  processRefund(currentRefundPendapatanId, reason, refundType);
}

// Refund processing functions
async function processRefund(pendapatanId, reason, refundType = 'mitra_fault') {
  try {
    const res = await fetch('/api/refunds/', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      credentials: 'same-origin',
      body: JSON.stringify({ 
        pendapatan_id: pendapatanId, 
        reason: reason,
        refund_type: refundType
      })
    });
    const json = await res.json();
    
    if (json.status !== 'ok') throw new Error(json.message || 'Failed to process refund');
    
    toasterUtils.success('Refund created successfully!', 3000);
    closeTransactionDetailsModal();
    fetchRefunds();
    fetchEarnings();
  } catch (err) {
    toasterUtils.error('Error: ' + err.message, 4000);
  }
}

// Create Refund Modal Functions
let selectedTransactionForRefund = null;

function openCreateRefundModal() {
  document.getElementById('createRefundModal').classList.remove('hidden');
  document.getElementById('transactionSelectContainer').classList.add('hidden');
  document.getElementById('refundTypeContainer').classList.add('hidden');
  document.getElementById('refundReasonContainer').classList.add('hidden');
  document.getElementById('submitRefundBtn').disabled = true;
  selectedTransactionForRefund = null;
  document.getElementById('createRefundType').value = 'mitra_fault';
  updateRefundTypeWarning();
  loadMitrasForRefund();
}

function closeCreateRefundModal() {
  document.getElementById('createRefundModal').classList.add('hidden');
  document.getElementById('createRefundMitra').value = '';
  document.getElementById('createRefundType').value = 'mitra_fault';
  document.getElementById('createRefundReason').value = '';
  document.getElementById('transactionsList').innerHTML = '<p class="text-neutral-500 text-sm">Select a mitra first...</p>';
}

function loadMitrasForRefund() {
  fetch(apiEarningsUrl, { credentials: 'same-origin' })
    .then(res => res.json())
    .then(json => {
      if (json.status === 'ok') {
        const select = document.getElementById('createRefundMitra');
        select.innerHTML = '<option value="">-- Select Mitra --</option>';
        
        json.data.forEach(mitra => {
          if (mitra.completed_transactions > 0) {
            const option = document.createElement('option');
            option.value = mitra.mitra_id;
            option.textContent = `${mitra.mitra_name} (${mitra.completed_transactions} transactions)`;
            select.appendChild(option);
          }
        });
      }
    })
    .catch(err => {
      console.error('Error loading mitras:', err);
      toasterUtils.error('Failed to load mitras', 3000);
    });
}

function loadMitraTransactionsForRefund() {
  const mitraId = document.getElementById('createRefundMitra').value;
  
  if (!mitraId) {
    document.getElementById('transactionSelectContainer').classList.add('hidden');
    document.getElementById('refundTypeContainer').classList.add('hidden');
    document.getElementById('refundReasonContainer').classList.add('hidden');
    return;
  }

  document.getElementById('transactionsList').innerHTML = '<p class="text-neutral-500 text-sm">Loading transactions...</p>';
  document.getElementById('transactionSelectContainer').classList.remove('hidden');

  fetch(`/api/mitra/${mitraId}/earnings/`, { credentials: 'same-origin' })
    .then(res => res.json())
    .then(json => {
      if (json.status === 'ok' && json.data.transactions) {
        const transactions = json.data.transactions;
        
        if (transactions.length === 0) {
          document.getElementById('transactionsList').innerHTML = '<p class="text-neutral-500 text-sm">No paid transactions available for refund</p>';
          return;
        }

        const transactionsList = document.getElementById('transactionsList');
        transactionsList.innerHTML = transactions.map(txn => `
          <div class="border border-neutral-200 rounded-lg p-4 cursor-pointer hover:border-primary-500 hover:bg-primary-50 transition-all" onclick="selectTransactionForRefund('${txn.id}', this)">
            <div class="flex justify-between items-start gap-4">
              <div class="flex-1">
                <p class="font-semibold text-neutral-900">${escapeHtml(txn.venue_name)} - ${escapeHtml(txn.court_name)}</p>
                <p class="text-sm text-neutral-600 mt-1">Customer: ${escapeHtml(txn.customer_name)}</p>
                <p class="text-sm text-neutral-600">Date: ${new Date(txn.booking_date).toLocaleDateString('id-ID')} | ${escapeHtml(txn.time_slot)}</p>
                ${txn.paid_at ? `<p class="text-xs text-neutral-500 mt-1">Paid: ${new Date(txn.paid_at).toLocaleDateString('id-ID')}</p>` : ''}
              </div>
              <div class="text-right">
                <p class="text-sm text-neutral-600">Total: Rp ${parseFloat(txn.amount).toLocaleString('id-ID')}</p>
                <p class="text-xs text-red-600">Commission: Rp ${parseFloat(txn.commission_amount).toLocaleString('id-ID')}</p>
                <p class="text-sm font-bold text-primary-600 mt-1">Net: Rp ${parseFloat(txn.net_amount).toLocaleString('id-ID')}</p>
              </div>
            </div>
          </div>
        `).join('');
      }
    })
    .catch(err => {
      console.error('Error loading transactions:', err);
      document.getElementById('transactionsList').innerHTML = '<p class="text-red-600 text-sm">Failed to load transactions</p>';
    });
}

function selectTransactionForRefund(pendapatanId, element) {
  // Remove previous selection
  document.querySelectorAll('#transactionsList > div').forEach(div => {
    div.classList.remove('border-primary-600', 'bg-primary-100', 'ring-2', 'ring-primary-500');
  });

  // Mark as selected
  element.classList.add('border-primary-600', 'bg-primary-100', 'ring-2', 'ring-primary-500');
  selectedTransactionForRefund = pendapatanId;

  console.log('Selected transaction for refund:', pendapatanId);

  // Show refund type and reason fields
  document.getElementById('refundTypeContainer').classList.remove('hidden');
  document.getElementById('refundReasonContainer').classList.remove('hidden');
  document.getElementById('submitRefundBtn').disabled = false;
}

function updateRefundTypeWarning() {
  const refundType = document.getElementById('createRefundType').value;
  const warningDiv = document.getElementById('refundTypeWarning');
  
  const warnings = {
    'mitra_fault': {
      color: 'red',
      text: '<strong>⚠️ Mitra Fault:</strong> The refund amount will be deducted from this mitra\'s earnings. Use when the venue/mitra caused the issue (e.g., court not available, facility problems).'
    },
    'customer_fault': {
      color: 'blue',
      text: '<strong>ℹ️ Customer Fault:</strong> The refund amount will still be deducted from mitra\'s earnings (customer already paid). Use for customer-initiated cancellations or no-shows where mitra wasn\'t at fault.'
    },
    'platform_fault': {
      color: 'yellow',
      text: '<strong>⚠️ Platform Fault:</strong> The platform will bear the refund cost - mitra earnings will NOT be affected. Use when LapangIN system errors or admin mistakes caused the issue.'
    },
    'force_majeure': {
      color: 'purple',
      text: '<strong>🌧️ Force Majeure:</strong> The platform will bear the refund cost due to extraordinary circumstances. Use for natural disasters, government restrictions, or unforeseeable events.'
    }
  };
  
  const warning = warnings[refundType];
  warningDiv.className = `mt-2 p-3 border rounded-lg bg-${warning.color}-50 border-${warning.color}-200`;
  warningDiv.innerHTML = `<p class="text-xs text-${warning.color}-700">${warning.text}</p>`;
}

function submitCreateRefund() {
  const reason = document.getElementById('createRefundReason').value.trim();
  const refundType = document.getElementById('createRefundType').value;

  if (!selectedTransactionForRefund) {
    toasterUtils.warning('Please select a transaction', 3000);
    return;
  }

  if (!reason) {
    toasterUtils.warning('Please enter a refund reason', 3000);
    return;
  }

  // Disable button during submission
  const submitBtn = document.getElementById('submitRefundBtn');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Processing...';

  const payload = {
    pendapatan_id: selectedTransactionForRefund,
    reason: reason,
    refund_type: refundType
  };
  
  console.log('Sending refund request:', payload);

  fetch('/api/refunds/', {
    method: 'POST',
    headers: { 
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    credentials: 'same-origin',
    body: JSON.stringify(payload)
  })
  .then(res => res.json())
  .then(json => {
    if (json.status === 'ok') {
      toasterUtils.success('Refund created successfully!', 3000);
      closeCreateRefundModal();
      fetchRefunds();
      fetchEarnings();
    } else {
      toasterUtils.error(json.message || 'Failed to create refund', 4000);
      submitBtn.disabled = false;
      submitBtn.textContent = 'Create Refund';
    }
  })
  .catch(err => {
    console.error('Error creating refund:', err);
    toasterUtils.error('Failed to create refund', 4000);
    submitBtn.disabled = false;
    submitBtn.textContent = 'Create Refund';
  })
  .finally(() => {
    submitBtn.disabled = false;
    submitBtn.textContent = 'Create Refund';
  });
}

// Helper function to get CSRF token
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

document.addEventListener('DOMContentLoaded', () => {
  fetchEarnings();
  fetchRefunds();
});
</script>
{% endblock %}
