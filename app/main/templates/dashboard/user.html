{% extends 'base.html' %}
{% block title %}Dashboard User - LapangIN{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-b from-white via-primary-50/30 to-white" id="userDashboard">
  <!-- Header -->
  <header class="relative border-b border-neutral-200/70 bg-white/80 backdrop-blur-md">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="py-6 flex items-center justify-between">
        <div class="scroll-animate">
          <h1 class="text-2xl md:text-3xl font-black text-neutral-900 leading-tight">
            Dashboard <span class="text-gradient-custom">User</span>
          </h1>
          <p class="text-neutral-600" id="welcomeMessage">Selamat datang kembali!</p>
        </div>

        <div class="flex items-center space-x-3 scroll-animate-right">
          <a href="/lapangan" class="hidden sm:inline-flex items-center px-4 py-2 rounded-xl font-semibold bg-white text-primary-600 border border-primary-100 hover:bg-neutral-50 transition-all shadow">
            Jelajahi Lapangan
            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/></svg>
          </a>
          <button onclick="logoutUser()" id="logoutBtn"
            class="inline-flex items-center px-4 py-2 rounded-xl font-semibold text-white bg-gradient-to-br from-primary-500 to-primary-700 hover:opacity-95 transition-all shadow-lg">
            Logout
            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H3"/></svg>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Loading State -->
  <div id="dashboardLoading" class="flex justify-center items-center py-20">
    <div class="w-10 h-10 border-4 border-teal-500 border-t-transparent rounded-full animate-spin"></div>
  </div>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 hidden" id="dashboardContent">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- User Info -->
      <aside class="lg:col-span-1 scroll-animate-left">
        <div class="bg-white/90 backdrop-blur-md rounded-2xl border border-neutral-200 shadow-xl p-6 relative overflow-hidden">
          <div class="absolute -top-10 -right-10 w-40 h-40 bg-primary-100 rounded-full blur-3xl"></div>
          <div class="text-center relative">
            <div class="w-20 h-20 rounded-2xl mx-auto mb-4 flex items-center justify-center shadow-lg bg-gradient-to-br from-primary-600 to-teal-600">
              <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
              </svg>
            </div>
            <h3 class="text-lg font-bold text-neutral-900 mb-0.5">
              {{ user.first_name }} {{ user.last_name }}
            </h3>
            <p class="text-neutral-600 text-sm mb-5">@{{ user.username }}</p>

            <div class="space-y-3 text-left">
              <div class="flex items-center justify-between text-sm">
                <span class="text-neutral-600">Email</span>
                <span class="font-medium text-neutral-900">{{ user.email }}</span>
              </div>
              {% if user.phone_number %}
              <div class="flex items-center justify-between text-sm">
                <span class="text-neutral-600">Telepon</span>
                <span class="font-medium text-neutral-900">{{ user.phone_number }}</span>
              </div>
              {% endif %}
              <div class="flex items-center justify-between text-sm">
                <span class="text-neutral-600">Bergabung</span>
                <span class="font-medium text-neutral-900">{{ user.created_at|date:"d M Y" }}</span>
              </div>
            </div>

            <a href="/profile/" class="mt-6 inline-flex w-full items-center justify-center px-4 py-3 rounded-xl font-semibold text-white bg-gradient-to-br from-primary-500 to-primary-700 hover:opacity-95 transition-all shadow">
              Edit Profil
            </a>
          </div>
        </div>

        <!-- Quick Actions (compact) -->
        <div class="mt-6 bg-white rounded-2xl border border-neutral-200 shadow p-6 scroll-animate">
          <h4 class="text-sm font-bold text-neutral-900 mb-3 uppercase tracking-wide">Aksi Cepat</h4>
          <div class="space-y-3">
            <a href="/lapangan" class="group block px-4 py-3 rounded-xl bg-neutral-50 hover:bg-neutral-100 transition-colors">
              <div class="flex items-center">
                <div class="w-10 h-10 rounded-xl flex items-center justify-center mr-3 bg-gradient-to-br from-primary-100 to-teal-100">
                  <svg class="w-5 h-5 text-primary-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                </div>
                <div>
                  <p class="font-medium text-neutral-900">Cari Lapangan</p>
                  <p class="text-xs text-neutral-600">Temukan lapangan favorit</p>
                </div>
              </div>
            </a>

            <a href="/booking-history" class="group block px-4 py-3 rounded-xl bg-neutral-50 hover:bg-neutral-100 transition-colors">
              <div class="flex items-center">
                <div class="w-10 h-10 rounded-xl flex items-center justify-center mr-3 bg-gradient-to-br from-secondary-100 to-primary-100">
                  <svg class="w-5 h-5 text-secondary-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/></svg>
                </div>
                <div>
                  <p class="font-medium text-neutral-900">Riwayat Booking</p>
                  <p class="text-xs text-neutral-600">Lihat semua booking Anda</p>
                </div>
              </div>
            </a>
          </div>
        </div>
      </aside>

      <!-- Right Column -->
      <section class="lg:col-span-2 space-y-6">
        <!-- Highlight banner -->
        <div class="relative rounded-2xl overflow-hidden p-6 bg-gradient-to-r from-primary-500 to-primary-700 text-white shadow-2xl scroll-animate-scale">
          <div class="absolute inset-0 bg-white/10 mix-blend-overlay"></div>
          <div class="relative flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <div>
              <p class="text-sm uppercase tracking-wider mb-1 opacity-90">Selamat datang</p>
              <h2 class="text-2xl font-black leading-tight">Siap Main Hari Ini?</h2>
              <p class="text-white/90">Cek booking terbaru atau cari lapangan favoritmu.</p>
            </div>
            <div class="flex items-center gap-3">
              <a href="/lapangan" class="inline-flex items-center px-4 py-3 rounded-xl bg-white text-primary-600 font-semibold hover:bg-neutral-50 transition-all shadow-lg">
                Cari Lapangan
                <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/></svg>
              </a>
              <a href="/booking-history" class="inline-flex items-center px-4 py-3 rounded-xl border-2 border-white/80 text-white font-semibold hover:bg-white hover:text-primary-600 transition-all">
                Riwayat
              </a>
            </div>
          </div>
        </div>

        <!-- Recent Bookings -->
        <div class="bg-white rounded-2xl shadow-xl border border-neutral-200 p-6 scroll-animate">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2">
              <div class="w-2 h-2 rounded-full bg-teal-500"></div>
              <h3 class="text-lg font-semibold text-neutral-900">Booking Terbaru</h3>
            </div>
            <a href="/booking-history" class="text-primary-600 hover:text-primary-700 text-sm font-semibold inline-flex items-center">
              Lihat Semua
              <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
            </a>
          </div>

          <!-- Loading -->
          <div id="bookingsLoading" class="text-center py-10">
            <svg class="animate-spin h-8 w-8 text-primary-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
            </svg>
            <p class="mt-2 text-neutral-600">Memuat booking...</p>
          </div>

          <!-- List -->
          <div id="bookingsList" class="space-y-4"></div>

          <!-- Empty -->
          <div id="bookingsEmpty" class="text-center py-10 hidden">
            <div class="w-16 h-16 bg-neutral-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
              <svg class="w-8 h-8 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/>
              </svg>
            </div>
            <h4 class="text-neutral-900 font-semibold mb-1">Belum ada booking</h4>
            <p class="text-neutral-600 text-sm mb-4">Mulai cari lapangan yang tersedia sekarang.</p>
            <a href="/lapangan" class="inline-flex items-center px-4 py-2 rounded-xl font-semibold text-white bg-gradient-to-r from-primary-500 to-primary-700 hover:opacity-95 transition-all shadow">
              Cari Lapangan
            </a>
          </div>
        </div>

        <!-- (Section Lapangan Favorit dihapus sesuai permintaan) -->
      </section>
    </div>
  </main>
</div>
{% endblock %}

{% block script %}
<script>
  // ---------- Load dashboard ----------
  document.addEventListener("DOMContentLoaded", async function () {
    try {
      const userStatus = await checkUserStatus();

      const dashboardData = await makeAjaxRequest("/api/user-dashboard/", {
        headers: { Accept: "application/json" },
      });

      if (dashboardData.success) {
        // Welcome line
        const welcomeMessage = document.getElementById("welcomeMessage");
        welcomeMessage.textContent = `Selamat datang kembali, ${dashboardData.data.user.first_name}!`;

        // Render dynamic content (kept consistent with visible DOM structure)
        renderDashboardContent(dashboardData.data);

        // Reveal content
        document.getElementById("dashboardLoading").classList.add("hidden");
        document.getElementById("dashboardContent").classList.remove("hidden");

        // Load bookings
        loadRecentBookings();
      }
    } catch (error) {
      console.error("Error loading dashboard:", error);
      showNotification("Gagal memuat dashboard. Silakan refresh halaman.", "error");
      document.getElementById("dashboardLoading").classList.add("hidden");
    }
  });

  function renderDashboardContent(data) {
    // Saat ini layout utama sudah statis di HTML.
    // Jika kamu ingin render full via JS (SPA-ish), tinggal ganti innerHTML di sini.
    // Dibiarkan minimal agar kompatibel dengan animasi & SSR Django.
  }

  // ---------- Navigation helpers ----------
  function editProfile() { window.location.href = "/profile/"; }
  function searchVenues() { window.location.href = "/lapangan"; }
  function viewBookings() { window.location.href = "/booking-history"; }
  // (viewFavorites dan section favorit DIHAPUS)

  // ---------- Load recent bookings ----------
  async function loadRecentBookings() {
    try {
      const bookingsLoading = document.getElementById("bookingsLoading");
      const bookingsList    = document.getElementById("bookingsList");
      const bookingsEmpty   = document.getElementById("bookingsEmpty");

      if (!bookingsLoading || !bookingsList || !bookingsEmpty) return;

      const response = await fetch("/bookings/history/?limit=3");
      const data = await response.json();

      bookingsLoading.classList.add("hidden");

      if (data.success && data.data.bookings.length > 0) {
        bookingsEmpty.classList.add("hidden");
        bookingsList.classList.remove("hidden");
        const recent = data.data.bookings.slice(0, 3);
        bookingsList.innerHTML = recent.map(createBookingItem).join("");
      } else {
        bookingsList.classList.add("hidden");
        bookingsEmpty.classList.remove("hidden");
      }
    } catch (err) {
      console.error("Error loading bookings:", err);
      const bookingsLoading = document.getElementById("bookingsLoading");
      const bookingsEmpty   = document.getElementById("bookingsEmpty");
      if (bookingsLoading) bookingsLoading.classList.add("hidden");
      if (bookingsEmpty) bookingsEmpty.classList.remove("hidden");
    }
  }

  function createBookingItem(booking) {
    const statusColors = {
      pending:   "bg-yellow-100 text-yellow-800",
      confirmed: "bg-blue-100 text-blue-800",
      completed: "bg-green-100 text-green-800",
      cancelled: "bg-red-100 text-red-800",
    };
    const statusLabels = {
      pending: "Menunggu",
      confirmed: "Dikonfirmasi",
      completed: "Selesai",
      cancelled: "Dibatalkan",
    };
    const statusColor = statusColors[booking.booking_status] || "bg-gray-100 text-gray-800";
    const statusLabel = statusLabels[booking.booking_status] || booking.booking_status;

    const bookingDate = new Date(booking.booking_date).toLocaleDateString("id-ID", {
      month: "short", day: "numeric",
    });

    // Card gaya “glass” + chip status
    return `
      <div class="p-4 rounded-xl bg-neutral-50 hover:bg-neutral-100 transition-colors border border-neutral-200/70">
        <div class="flex items-center justify-between gap-4">
          <div class="min-w-0">
            <div class="flex items-center gap-2 mb-1">
              <h4 class="font-semibold text-neutral-900 truncate">${booking.venue_name}</h4>
              <span class="px-2 py-0.5 rounded-full text-xs font-bold ${statusColor}">${statusLabel}</span>
            </div>
            <p class="text-sm text-neutral-600 truncate">
              ${booking.court_name} • ${bookingDate} ${booking.start_time}
            </p>
          </div>
          <div class="text-right shrink-0">
            <p class="font-bold text-neutral-900">
              Rp ${parseInt(booking.total_price).toLocaleString("id-ID")}
            </p>
            <a href="/booking-history" class="text-primary-600 hover:text-primary-700 text-xs font-semibold inline-flex items-center">
              Lihat Detail
              <svg class="w-3.5 h-3.5 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </a>
          </div>
        </div>
      </div>
    `;
  }
</script>
{% endblock %}
